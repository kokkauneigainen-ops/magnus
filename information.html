<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>国家情報ページ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* ダークモード＆明朝体＆シックなデザイン設定 */
        :root {
            --primary-color: #d4af37; /* シックなゴールド */
            --accent-color: #c0a060;
            --bg-color: #1a1a1a;    /* 深い黒 */
            --card-bg: #2d2d2d;     /* 暗いグレー */
            --text-color: #e0e0e0;  /* 明るいグレー */
            --text-muted: #a0a0a0;
        }

        body {
            /* 明朝体フォントスタック */
            font-family: "Noto Serif JP", "Yu Mincho", YuMincho, "Hiragino Mincho ProN", serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        /* ヘッダーエリア */
        header {
            background-color: var(--card-bg);
            padding: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #444;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo {
            height: 40px;
            width: auto;
            filter: brightness(0.8); /* ロゴも少し暗く馴染ませる */
        }

        h1 {
            font-size: 1.2rem;
            font-weight: normal;
            margin: 0;
            color: var(--primary-color);
        }

        /* 戻るボタン */
        .back-btn {
            background-color: transparent;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            padding: 5px 12px;
            border-radius: 2px;
            text-decoration: none;
            font-size: 0.9rem;
            cursor: pointer;
            font-family: inherit;
            transition: background-color 0.3s;
        }
        .back-btn:hover {
            background-color: rgba(212, 175, 55, 0.2);
        }

        /* メインコンテンツ */
        main {
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }

        /* 国名表示エリア */
        .country-title {
            text-align: center;
            margin-bottom: 30px;
            margin-top: 10px;
        }
        .country-title h2 {
            font-size: 2rem;
            font-weight: normal;
            border-bottom: 2px solid var(--accent-color);
            display: inline-block;
            padding-bottom: 10px;
            margin: 0;
            letter-spacing: 0.1em;
        }

        /* 情報カードのスタイル */
        .info-card, .chart-container {
            background-color: var(--card-bg);
            border: 1px solid #444;
            border-radius: 4px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: normal;
            color: var(--primary-color);
            margin-bottom: 20px;
            text-align: center;
            letter-spacing: 0.05em;
        }
        
        /* リスト表示スタイル */
        .data-list {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
        }
        .data-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #555;
            padding-bottom: 8px;
        }
        .data-label {
            font-size: 0.95rem;
            color: var(--text-muted);
        }
        .data-value {
            font-size: 1.05rem;
            text-align: right;
        }

        /* グラフ用コンテナ */
        .chart-wrapper {
            position: relative;
            width: 100%;
            min-height: 300px; 
        }
        .chart-wrapper.world-comparison {
            min-height: 500px;
        }

        /* 円グラフを横並びにするためのグリッド */
        .pie-charts-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }
        @media (min-width: 600px) {
            .pie-charts-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        /* 読み込み中 */
        #loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2rem;
            color: var(--primary-color);
        }
        #content-area { display: none; }
    </style>
</head>
<body>

    <header>
        <div class="header-left">
            <img src="stella.png" alt="Stella Logo" class="logo">
            <h1>国家情報ページ</h1>
        </div>
        <button class="back-btn" onclick="window.history.back()">戻る</button>
    </header>

    <div id="loading">データを読み込んでいます...</div>

    <main id="content-area">
        <div class="country-title">
            <h2 id="display-country-name">Country Name</h2>
        </div>

        <section class="info-card">
            <div class="section-title">基本情報</div>
            <div class="data-list" id="basic-info-list"></div>
        </section>

        <section class="info-card">
            <div class="section-title">所持資源</div>
            <div class="data-list" id="resource-info-list"></div>
        </section>

        <section class="chart-container">
            <div class="section-title">世界の国力差</div>
            <div class="chart-wrapper world-comparison">
                <canvas id="worldComparisonChart"></canvas>
            </div>
        </section>

        <section class="chart-container">
            <div class="section-title">財源・財政状況</div>
            
            <div style="margin-bottom: 40px;">
                <div class="section-title" style="font-size: 1.1rem;">財政収支</div>
                <div class="chart-wrapper" style="min-height: 250px;">
                    <canvas id="financeChart"></canvas>
                </div>
            </div>

            <div class="pie-charts-grid">
                <div>
                    <div class="section-title" style="font-size: 1.1rem;">歳出の割合</div>
                    <div class="chart-wrapper" style="min-height: 300px;">
                        <canvas id="expenditurePieChart"></canvas>
                    </div>
                </div>
                <div>
                    <div class="section-title" style="font-size: 1.1rem;">歳入の割合</div>
                    <div class="chart-wrapper" style="min-height: 300px;">
                        <canvas id="revenuePieChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <script>

        const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSWkKqBxqKcCguYIKLw5geYJCp14BBvgiOkc7a69uCdMRwAZWXZWc2VcecTlFoWQss0Iyu6yBZSOfnk/pub?gid=301877007&single=true&output=csv';

        // 列インデックス定義 (0始まり)
        const COLS = {
            COUNTRY: 0, 
            BASIC: [1, 2, 3, 4, 5, 12, 13, 16, 17, 18, 19],
            RESOURCE: [6, 7, 8, 9, 10],
            // グラフ用データ
            COMPARE_C: 2, COMP_D: 3, COMP_T: 19,
            REVENUE_PIE: [21, 22, 23, 24], // V-Z
            EXPEND_PIE: [25, 26, 27, 28, 29, 30, 31, 32, 33], // AA-AH
            EXPEND_TOTAL: 34, // AI
            REVENUE_TOTAL: 35 // AJ
        };

        // Chart.js共通設定
        Chart.defaults.color = '#a0a0a0';
        Chart.defaults.borderColor = '#444';
        Chart.defaults.font.family = '"Noto Serif JP", "Yu Mincho", serif';

        document.addEventListener('DOMContentLoaded', async () => {
            const loginCountry = sessionStorage.getItem('loginCountry');
            if (!loginCountry) {
                alert('ログイン情報が見つかりません。');
                document.getElementById('loading').textContent = "ログインエラー";
                return;
            }
            document.getElementById('display-country-name').textContent = loginCountry;

            try {
                const response = await fetch(SHEET_CSV_URL);
                if (!response.ok) throw new Error("Network response not ok");
                const csvText = await response.text();
                const rows = parseCSV(csvText);
                const headers = rows[0];
                const dataRows = rows.slice(1).filter(row => row[COLS.COUNTRY] && row[COLS.COUNTRY].trim() !== '');
                
                const targetRow = dataRows.find(row => row[COLS.COUNTRY] === loginCountry);

                if (targetRow) {
                    renderList('basic-info-list', headers, targetRow, COLS.BASIC);
                    renderList('resource-info-list', headers, targetRow, COLS.RESOURCE);

                    drawWorldComparisonChart(headers, dataRows);
                    drawFinanceChart(headers, targetRow);
                    drawPieChart('expenditurePieChart', headers, targetRow, COLS.EXPEND_PIE);
                    drawPieChart('revenuePieChart', headers, targetRow, COLS.REVENUE_PIE);

                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('content-area').style.display = 'block';
                } else {
                    throw new Error(`「${loginCountry}」のデータが見つかりません。`);
                }

            } catch (error) {
                console.error('Error:', error);
                document.getElementById('loading').textContent = 'データ取得エラー: ' + error.message;
            }
        });

        // リスト描画
        function renderList(containerId, headers, rowData, colIndices) {
            const container = document.getElementById(containerId);
            let html = '';
            colIndices.forEach(index => {
                if (headers[index] && rowData[index] !== undefined) {
                    html += `<div class="data-item"><span class="data-label">${headers[index]}</span><span class="data-value">${rowData[index]}</span></div>`;
                }
            });
            container.innerHTML = html;
        }

        const toNum = (str) => {
            if(!str) return 0;
            const num = parseFloat(str.replace(/[, \s]/g, ''));
            return isNaN(num) ? 0 : num;
        };

        // 1. 世界の国力差グラフ
        function drawWorldComparisonChart(headers, dataRows) {
            const ctx = document.getElementById('worldComparisonChart').getContext('2d');
            const labels = dataRows.map(row => row[COLS.COUNTRY]);
            
            const datasets = [
                { label: headers[COLS.COMPARE_C], data: dataRows.map(r => toNum(r[COLS.COMPARE_C])), backgroundColor: '#c0392b' }, // 深い赤
                { label: headers[COLS.COMP_D],   data: dataRows.map(r => toNum(r[COLS.COMP_D])),   backgroundColor: '#2980b9' }, // 落ち着いた青
                { label: headers[COLS.COMP_T],   data: dataRows.map(r => toNum(r[COLS.COMP_T])),   backgroundColor: '#f39c12' }  // 落ち着いたオレンジ
            ];

            new Chart(ctx, {
                type: 'bar',
                data: { labels, datasets },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { x: { stacked: true }, y: { stacked: true } },
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }

        // 2. 財政グラフ
        function drawFinanceChart(headers, row) {
            const ctx = document.getElementById('financeChart').getContext('2d');
            const expendVal = toNum(row[COLS.EXPEND_TOTAL]);
            const revenueVal = toNum(row[COLS.REVENUE_TOTAL]);

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [headers[COLS.EXPEND_TOTAL], headers[COLS.REVENUE_TOTAL]],
                    datasets: [{
                        data: [expendVal, revenueVal],
                        backgroundColor: ['#e74c3c', '#3498db'] // 赤, 青
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });
        }

        // 3 & 4. 円グラフ（ここを修正：色指定をJS内に直接記述）
        function drawPieChart(canvasId, headers, row, colIndices) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            
            const labels = [];
            const data = [];
            colIndices.forEach(idx => {
                labels.push(headers[idx]);
                data.push(toNum(row[idx]));
            });

            // 修正：ここにパレットを直接定義（ダークモードに合うシックな色）
            const palette = [
                '#c0392b', // 深紅
                '#8e44ad', // 紫
                '#2980b9', // 青
                '#16a085', // 青緑
                '#d35400', // テラコッタ
                '#f39c12', // 黄土色
                '#7f8c8d', // スレートグレイ
                '#27ae60', // 緑
                '#deb887'  // いい感じのクリーム
            ];

            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: palette,
                        borderColor: '#2d2d2d', // 境界線を背景色に合わせて隙間を作る
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { padding: 20, color: '#e0e0e0' }
                        }
                    }
                }
            });
        }

        function parseCSV(text) {
            return text.split(/\r\n|\n/)
                       .filter(line => line.trim() !== '')
                       .map(line => line.split(','));
        }
    </script>
</body>
</html>
