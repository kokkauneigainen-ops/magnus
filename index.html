<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Territory System</title>
<style>
  /* --- スタイル定義 --- */
  body {
    margin: 0; padding: 0;
    font-family: "Sawarabi Mincho", serif;
    background-color: #1a1a1a; color: #e0e0e0;
    height: 100vh; display: flex; flex-direction: column; overflow: hidden;
  }
  
  header {
    background: #000; padding: 10px 15px; border-bottom: 1px solid #333;
    display: flex; justify-content: space-between; align-items: center; flex: 0 0 auto;
  }
  
  .nav-bar {
    background: #252525; padding: 8px; border-bottom: 1px solid #333;
    display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; flex: 0 0 auto;
  }
  .nav-btn {
    background: #3d3d3d; border: 1px solid #555; color: #ddd;
    padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 13px;
  }
  .nav-btn.active { background: #0056b3; border-color: #007bff; color: white; }

  .main-container {
    display: flex; flex: 1; position: relative; overflow: hidden;
    flex-direction: column;
  }
  @media(min-width: 768px) { .main-container { flex-direction: row; } }

  #map-area {
    flex: 1; background: #0e0e0e; position: relative; overflow: hidden;
    display: flex; align-items: center; justify-content: center;
  }
  #main-map-svg {

    }
  
  #info-panel {
    flex: 0 0 40%; 
    background: #202020; border-top: 2px solid #444;
    padding: 15px; box-sizing: border-box; overflow-y: auto;
    font-family: sans-serif;
  }
  @media(min-width: 768px) {
    #info-panel { flex: 0 0 340px; border-top: none; border-left: 2px solid #444; height: auto; }
  }

  .zoom-ctrl {
    position: absolute; left: 10px; top: 50%; transform: translateY(-50%);
    display: flex; flex-direction: column; gap: 10px; z-index: 10;
  }
  .zoom-btn {
    width: 40px; height: 40px; background: rgba(50,50,50,0.8);
    color: #fff; border: 1px solid #666; border-radius: 5px; cursor: pointer; font-size: 18px;
  }
  
  /* アクションボタン */
  .act-btn { 
    width: 100%; padding: 10px; margin-top: 8px; 
    border: none; border-radius: 4px; font-weight: bold; cursor: pointer; color: white; 
    display: flex; justify-content: space-between; align-items: center;
  }
  .btn-green { background: #28a745; }
  .btn-red { background: #dc3545; }
  .btn-disabled { background: #555; color: #aaa; cursor: not-allowed; }
  .btn-label { font-size: 14px; }
  .btn-sub { font-size: 11px; font-weight: normal; opacity: 0.8; }

  /* 保存バー */
  #save-bar {
    background: #004085; border: 1px solid #b8daff; color: #fff;
    padding: 10px; border-radius: 5px; text-align: center; margin-bottom: 15px;
    display: none; 
  }
  .save-trigger-btn {
    background: #007bff; border: none; color: white; padding: 8px 16px; 
    border-radius: 4px; cursor: pointer; margin-top: 5px; font-weight: bold;
  }

  /* ログインモーダル */
  #modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.9); z-index: 999; display: flex; align-items: center; justify-content: center;
  }
  .login-box {
    background: #333; padding: 30px; border-radius: 8px; width: 300px; text-align: center;
  }
  .login-input { width: 100%; padding: 10px; margin: 10px 0; box-sizing: border-box; }

</style>
</head>
<body>

<div id="modal-overlay">
  <div class="login-box">
    <h3>領土管理システム</h3>
    <div id="login-loading">Loading...</div>
    <div id="login-form" style="display:none;">
      <select id="login-country" class="login-input"></select>
      <input type="password" id="login-pass" class="login-input" placeholder="Password">
      <button onclick="doLogin()" class="login-input" style="background:#555; color:#fff; cursor:pointer;">ログイン</button>
    </div>
  </div>
</div>

<header>
  <strong>Territory Map</strong>
  <span id="header-user" style="font-size:0.8rem; color:#aaa;">未認証</span>
</header>

<div class="nav-bar">
  <button class="nav-btn" id="btn-policy" onclick="changeMode('policy')">経済政策</button>
  <button class="nav-btn" id="btn-domestic" onclick="changeMode('domestic')">内政政策</button>
  <button class="nav-btn" id="btn-land" onclick="changeMode('land')">国土開発</button>
  <button class="nav-btn" id="btn-industry" onclick="changeMode('industry')">産業開発</button>
  <button class="nav-btn" id="btn-normal" onclick="changeMode('normal')">通常地図</button>
</div>

<div class="main-container">
  <div id="map-area">
    <div class="zoom-ctrl">
      <button class="zoom-btn" onclick="zoomMap(1.2)">＋</button>
      <button class="zoom-btn" onclick="zoomMap(0.8)">－</button>
    </div>
    
    <svg id="main-map-svg" viewBox="0 0 800 600" xmlns="http://www.w3.org/2000/svg">
       <rect width="8000" height="6000" x="-1000" y="-1000" fill="#0e0e0e"></rect> 
       </svg>
  </div>

  <div id="info-panel">
    <div id="save-bar">
      <div>未保存の変更があります</div>
      <button class="save-trigger-btn" onclick="sendBatchUpdate()">変更を保存する</button>
    </div>
    <h3 id="panel-title">Information</h3>
    <div id="panel-content">マップを選択してください</div>
  </div>
</div>

<script src="https://unpkg.com/svg-pan-zoom@3.6.1/dist/svg-pan-zoom.min.js"></script>
<script>
// ▼▼ GASのURL ▼▼
const API_URL = 'https://script.google.com/macros/s/AKfycbyFPxJWUbGHsxVzcOiDZWxn3a175hSKD6ErhEiKlXOHPyXYUW1KWq0FE4q8iH2XZLL7lg/exec';

// --- グローバル変数 ---
let myCountry = null;
let baseMapData = {}; 
let myPolicyData = {}; 
let actionData = {}; // { ID: {policy:0, domestic:0, land:0, metal:0...} }
let pendingData = {}; // { "ID_TYPE": {id:"ID", type:"TYPE", val:1} } 
// ※複数ボタンの同時操作を許容するため、キーにTYPEを含める構造に変更
let currentMode = 'normal';
let pzInstance = null;
let currentSelectedId = null; // 現在選択中のID

document.addEventListener('DOMContentLoaded', () => {
  const svg = document.getElementById('main-map-svg');
  if(!svg) { alert('エラー: SVGタグがありません'); return; }
  
  fetch(API_URL + '?op=getCountryList')
    .then(r => r.json()).then(res => {
      if(res.status === 'success') {
        const sel = document.getElementById('login-country');
        res.data.forEach(c => { const o=document.createElement('option'); o.value=o.text=c; sel.appendChild(o); });
        document.getElementById('login-loading').style.display = 'none';
        document.getElementById('login-form').style.display = 'block';
      }
    }).catch(e => alert('通信エラー: ' + e));
  setupPanZoom();
});

function doLogin() {
  const c = document.getElementById('login-country').value;
  const p = document.getElementById('login-pass').value;
  if(!c) return;
  document.getElementById('login-loading').style.display = 'block';
  document.getElementById('login-form').style.display = 'none';

  fetch(`${API_URL}?op=login&country=${encodeURIComponent(c)}&password=${encodeURIComponent(p)}`)
    .then(r => r.json()).then(res => {
      if(res.status === 'success') {
        myCountry = c;
        document.getElementById('header-user').textContent = c;
        document.getElementById('modal-overlay').style.display = 'none';
        loadAllData(); 
      } else {
        alert('認証失敗');
        document.getElementById('login-loading').style.display = 'none';
        document.getElementById('login-form').style.display = 'block';
      }
    });
}

function loadAllData() {
  Promise.all([
    fetch(API_URL + '?op=getMapData').then(r=>r.json()),
    fetch(`${API_URL}?op=getPolicyData&country=${encodeURIComponent(myCountry)}`).then(r=>r.json()),
    fetch(API_URL + '?op=getActionData').then(r=>r.json())
  ]).then(([mapRes, polRes, actRes]) => {
    if(mapRes.status === 'success') baseMapData = mapRes.data;
    if(polRes.status === 'success') myPolicyData = polRes.data;
    if(actRes.status === 'success') actionData = actRes.data;

    document.getElementById('main-map-svg').addEventListener('click', onMapClick);
    changeMode('normal');
  });
}

function changeMode(mode) {
  currentMode = mode;
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  const btn = document.getElementById('btn-' + mode);
  if(btn) btn.classList.add('active');

  const titles = {
    'policy': '経済政策レポート',
    'domestic': '内政状況レポート',
    'land': '国土開発レポート',
    'industry': '産業開発レポート',
    'normal': '通常地図'
  };
  document.getElementById('panel-title').textContent = titles[mode] || mode;

  drawMap();
  if(currentSelectedId) showInfo(currentSelectedId); // パネル再描画
  else document.getElementById('panel-content').innerHTML = '<p>領域を選択してください</p>';
}

// --- 描画ロジック ---
function drawMap() {
  const svg = document.getElementById('main-map-svg');
  if(!svg) return;

  // 全リセット（暗くする）
  const paths = svg.querySelectorAll('path, polygon, circle, rect');
  paths.forEach(p => {
    if(p.getAttribute('fill') === '#0e0e0e') return; // 背景除外
    p.style.fill = '#111'; 
    p.style.stroke = '#222';
    p.style.strokeWidth = '0.2px';
  });

  if (currentMode === 'normal') {
    for(const id in baseMapData) {
      const el = document.getElementById(id);
      if(el) {
        el.style.fill = baseMapData[id].Color || '#333';
        el.style.stroke = '#000';
      }
    }
  } else {
    // 政策系モード
    let values = [];
    Object.keys(myPolicyData).forEach(id => {
      let val = 0;
      if(currentMode === 'policy') val = myPolicyData[id]._Value;
      else if(currentMode === 'domestic' && baseMapData[id]) val = baseMapData[id]._ColF;
      else if(currentMode === 'land' && baseMapData[id]) val = baseMapData[id]._ColE;
      else if(currentMode === 'industry') val = 1; // 産業は一律表示でOK（ボタンで制御）
      values.push(val);
    });
    
    const min = Math.min(...values);
    const max = Math.max(...values) || (min + 1);

    Object.keys(myPolicyData).forEach(id => {
      const el = document.getElementById(id);
      if(el) {
        // 色塗り
        let val = 0;
        if(currentMode === 'policy') val = myPolicyData[id]._Value;
        else if(currentMode === 'domestic' && baseMapData[id]) val = baseMapData[id]._ColF;
        else if(currentMode === 'land' && baseMapData[id]) val = baseMapData[id]._ColE;
        else if(currentMode === 'industry') val = 1;

        // 産業モードは一律青系、他はヒートマップ
        if(currentMode === 'industry') {
            el.style.fill = '#2c3e50';
        } else {
            const ratio = (val - min) / (max - min);
            const hue = Math.floor(ratio * 120); 
            el.style.fill = `hsl(${hue}, 70%, 40%)`;
        }

        // ★ 黄色枠線ロジック ★
        // そのモードのアクションがONなら黄色枠
        // 産業モードの場合は「いずれかの産業」がONなら黄色にする？
        // 要件：すべて「経済システムと同じ動き」。
        // つまり、経済なら経済ON、内政なら内政ON、産業なら...？ 
        // 産業は複数あるので、産業モードでは「何かが建設されていたら」黄色とします。
        
        let isActive = false;
        if(currentMode === 'industry') {
            const d = getCombinedActionData(id);
            if(d.metal || d.rare || d.food || d.fuel || d.civilian || d.military) isActive = true;
        } else {
            isActive = (getActiveStatus(id, currentMode) === 1);
        }

        if(isActive) {
          el.style.stroke = '#FFD700'; // Gold
          el.style.strokeWidth = '1.5px';
          el.parentNode.appendChild(el); // 最前面
        } else {
          el.style.stroke = '#fff';
          el.style.strokeWidth = '0.2px';
        }
      }
    });
  }
  
  // 選択中の強調は最後に上書き
  if(currentSelectedId) {
    const el = document.getElementById(currentSelectedId);
    if(el) {
       el.style.stroke = '#ffffff';
       el.style.strokeWidth = '2.5px';
       el.parentNode.appendChild(el);
    }
  }
}

function onMapClick(e) {
  const target = e.target.closest('path, polygon, circle, rect');
  if(!target || !target.id || target.getAttribute('fill')==='#0e0e0e') return;
  currentSelectedId = target.id;
  drawMap();
  showInfo(target.id);
}

// --- 詳細パネルとボタン生成 ---
function showInfo(id) {
  const container = document.getElementById('panel-content');
  let html = `<h4>${id}</h4>`;
  const mapInfo = baseMapData[id];
  const polInfo = myPolicyData[id]; // 自国データ

  if(mapInfo) {
    // 簡易ステータス表示
    html += `<div style="font-size:0.85em; color:#ccc; margin-bottom:10px;">
      治安: ${mapInfo._ColF} | 開発: ${mapInfo._ColE}
    </div>`;
  }

  if(currentMode !== 'normal') {
    if(polInfo) {
      // --- 経済・内政・開発モード ---
      if(currentMode === 'policy' || currentMode === 'domestic' || currentMode === 'land') {
          const isActive = getActiveStatus(id, currentMode);
          let label = "", sub = "", disabled = false, actionType = currentMode;
          
          if(currentMode === 'policy') {
              label = isActive ? '経済政策を取り消す' : '経済政策を行う';
          } else if(currentMode === 'domestic') {
              label = isActive ? '内政政策を取り消す' : '内政政策を行う';
              if(!isActive && mapInfo._ColF > 80) { disabled = true; sub = "治安80超のため不可"; }
          } else if(currentMode === 'land') {
              label = isActive ? '国土開発を取り消す' : '国土開発を行う';
              if(!isActive && mapInfo._ColE > 50) { disabled = true; sub = "開発50超のため不可"; }
          }
          
          html += createBtnHtml(actionType, id, isActive, label, sub, disabled);
      }
      
      // --- 産業開発モード ---
      else if(currentMode === 'industry') {
          // 金属 (Policy G >= 1)
          if(polInfo._Metal >= 1) {
             const act = getActiveStatus(id, 'metal');
             html += createBtnHtml('metal', id, act, (act?'金属鉱山を破棄':'金属鉱山を建設'), '資源あり');
          }
          // レアメタル (Policy H >= 1)
          if(polInfo._Rare >= 1) {
             const act = getActiveStatus(id, 'rare');
             html += createBtnHtml('rare', id, act, (act?'レアメタル鉱山を破棄':'レアメタル鉱山を建設'), '資源あり');
          }
          // 食糧 (Policy I >= 1) - 想定
          if(polInfo._Food >= 1) {
             const act = getActiveStatus(id, 'food');
             html += createBtnHtml('food', id, act, (act?'農場を破棄':'食糧資源を建設'), '適正あり');
          }
          // 燃料 (Policy J >= 1) - 想定
          if(polInfo._Fuel >= 1) {
             const act = getActiveStatus(id, 'fuel');
             html += createBtnHtml('fuel', id, act, (act?'油田/炭鉱を破棄':'燃料資源を建設'), '資源あり');
          }
          
          // 民需・軍需 (常時表示)
          const civ = getActiveStatus(id, 'civilian');
          html += createBtnHtml('civilian', id, civ, (civ?'民需工場を解体':'民需工場を建設'), '常時可能');
          
          const mil = getActiveStatus(id, 'military');
          html += createBtnHtml('military', id, mil, (mil?'軍需工場を解体':'軍需工場を建設'), '常時可能');
      }

    } else {
      html += `<p style="color:#888;">他国領土のため操作できません。</p>`;
    }
  }
  container.innerHTML = html;
}

function createBtnHtml(type, id, isActive, label, sub, disabled=false) {
    if(disabled) {
        return `<button class="act-btn btn-disabled" disabled>
                  <span class="btn-label">${label}</span>
                  <span class="btn-sub">${sub}</span>
                </button>`;
    }
    const colorClass = isActive ? 'btn-red' : 'btn-green';
    return `<button class="act-btn ${colorClass}" onclick="toggleAction('${type}', '${id}')">
              <span class="btn-label">${label}</span>
              <span class="btn-sub">${sub}</span>
            </button>`;
}

// --- アクション切り替え ---
function toggleAction(type, id) {
  const cur = getActiveStatus(id, type);
  const next = cur === 1 ? 0 : 1;

  // キーを一意にする "ID_TYPE"
  const key = `${id}_${type}`;
  pendingData[key] = { id: id, type: type, val: next };
  
  document.getElementById('save-bar').style.display = 'block';
  
  // 即時反映
  drawMap(); 
  showInfo(id);
}

// 現在のステータスを取得 (未保存 > 保存済み > 0)
function getActiveStatus(id, type) {
  const key = `${id}_${type}`;
  if(pendingData[key]) return pendingData[key].val;
  
  if(actionData[id] && actionData[id][type] !== undefined) {
      return actionData[id][type];
  }
  return 0;
}

// マップ描画用にIDの全データを合成して取得するヘルパー
function getCombinedActionData(id) {
    // ベース
    let d = actionData[id] ? {...actionData[id]} : {};
    // 未保存を上書き
    for(let k in pendingData) {
        if(pendingData[k].id === id) {
            d[pendingData[k].type] = pendingData[k].val;
        }
    }
    return d;
}

function sendBatchUpdate() {
  const btn = document.querySelector('.save-trigger-btn');
  btn.disabled = true; btn.textContent = '送信中...';

  
  // 送信データ準備 (pendingDataには {id, type, val} が入っている)
  const payload = JSON.stringify(pendingData);

  fetch(`${API_URL}?op=bulkUpdate&updates=${encodeURIComponent(payload)}`)
    .then(r => r.json()).then(res => {
      if(res.status === 'success') {
        // 確定反映
        for(let k in pendingData) {
            const p = pendingData[k]; // {id, type, val}
            if(!actionData[p.id]) actionData[p.id] = {};
            actionData[p.id][p.type] = p.val;
        }
        pendingData = {};
        document.getElementById('save-bar').style.display = 'none';
        alert('保存しました');
      } else {
        alert('保存失敗: ' + (res.message || 'Unknown'));
      }
      btn.disabled = false; btn.textContent = '変更を保存する';
    });
}

function setupPanZoom() {
  setTimeout(() => {
    const svg = document.getElementById('main-map-svg');
    if(svg) {
      pzInstance = svgPanZoom(svg, {
        zoomEnabled: true, controlIconsEnabled: false,
        fit: true, center: true, minZoom: 0.5, maxZoom: 20
      });
    }
  }, 500);
}
function zoomMap(k) { if(pzInstance) k>1 ? pzInstance.zoomBy(1.2) : pzInstance.zoomBy(0.8); }
</script>
</body>
</html>
