<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Territory Management System</title>
    <style>
        /* --- 全体デザイン --- */
        body { 
            font-family: "Sawarabi Mincho", "Hiragino Mincho ProN", "MS PMincho", serif; 
            margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden;
            background-color: #1a1a1a; color: #e0e0e0;
        }
        
        /* ログイン画面 */
        #login-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 1000;
            display: flex; justify-content: center; align-items: center;
        }
        .login-box {
            background: #2d2d2d; padding: 30px; border-radius: 12px; width: 90%; max-width: 400px; 
            text-align: center; border: 1px solid #444; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .login-box select, .login-box input, .login-box button {
            width: 100%; padding: 12px; margin: 10px 0; font-size: 16px; border-radius: 4px;
            border: 1px solid #555; background: #3d3d3d; color: #fff; box-sizing: border-box;
        }
        .login-box button { background: #555; cursor: pointer; border: none; transition: 0.3s; }
        
        /* ヘッダー */
        header { padding: 10px 20px; background: #000; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; }
        .button-bar { 
            display: flex; flex-wrap: wrap; background: #252525; padding: 8px; gap: 8px; 
            justify-content: center; border-bottom: 1px solid #333;
        }
        .button-bar button {
            padding: 6px 12px; font-family: serif; background: #3d3d3d; color: #ddd; 
            border: 1px solid #555; border-radius: 4px; cursor: pointer; font-size: 14px;
        }
        .button-bar button.active { background: #666; color: #fff; border-color: #888; }

        /* マップエリア */
        .container { display: flex; flex-grow: 1; overflow: hidden; flex-direction: column; position: relative; }
        #map-wrapper { 
            flex-grow: 1; background: #0e0e0e; position: relative; overflow: hidden; 
            display: flex; justify-content: center; align-items: center;
        }
        /* SVGの背景色を強制指定 */
        #map-wrapper svg { width: 100%; height: 100%; touch-action: none; background-color: #0e0e0e; }

        .zoom-controls {
            position: absolute; left: 15px; top: 50%; transform: translateY(-50%);
            display: flex; flex-direction: column; gap: 15px; z-index: 500;
        }
        .zoom-btn {
            width: 50px; height: 50px; background: rgba(50, 50, 50, 0.8); color: white;
            border: 1px solid #666; border-radius: 10px; font-size: 24px; font-weight: bold;
            cursor: pointer; display: flex; justify-content: center; align-items: center;
        }

        /* 情報パネル */
        #info-panel {
            height: 35%; min-height: 200px; background: #252525; border-top: 2px solid #444;
            padding: 20px; overflow-y: auto; box-sizing: border-box; font-family: sans-serif;
            position: relative;
        }
        #info-panel h3 { margin-top: 0; border-left: 4px solid #888; padding-left: 10px; font-family: serif; }
        
        /* アクションボタン群 */
        .action-btn {
            width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 5px; border: none;
            font-weight: bold; cursor: pointer; font-size: 14px; transition: 0.2s;
        }
        .btn-do { background-color: #28a745; color: white; } /* 緑 */
        .btn-cancel { background-color: #dc3545; color: white; } /* 赤 */
        
        /* 保存ボタン（未保存があるときに出現） */
        #save-bar {
            background: #254060; border: 1px solid #4da3ff; padding: 10px; border-radius: 5px;
            margin-bottom: 15px; display: none; /* 初期は非表示 */
            text-align: center;
        }
        .btn-save {
            background-color: #007bff; color: white; width: 100%; padding: 10px;
            font-weight: bold; border: none; border-radius: 4px; cursor: pointer;
        }
        .btn-save:hover { background-color: #0069d9; }

        @media (min-width: 768px) {
            .container { flex-direction: row; }
            #info-panel { width: 350px; height: auto; border-top: none; border-left: 2px solid #444; }
        }
    </style>
</head>
<body>

    <div id="login-modal">
        <div class="login-box">
            <h2>領土管理システム</h2>
            <p id="loading-msg">暗号化データを復号中...</p>
            <div id="login-form" style="display:none;">
                <select id="country-select"><option value="">所属を選択</option></select>
                <input type="password" id="password-input" placeholder="秘密鍵を入力">
                <button onclick="tryLogin()">アクセス承認</button>
            </div>
        </div>
    </div>

    <header>
        <span style="font-size: 1.1em; font-weight: bold;">Territory System</span>
        <span id="user-display" style="font-size:0.8em;">Unauthorized</span>
    </header>

    <div class="button-bar">
        <button onclick="switchMode('policy')" id="btn-policy">経済政策</button>
        <button onclick="switchMode('domestic')" id="btn-domestic">内政政策</button>
        <button onclick="switchMode('industry')" id="btn-industry">産業開発</button>
        <button onclick="switchMode('land')" id="btn-land">国土開発</button>
        <button onclick="switchMode('transfer')" id="btn-transfer">領土譲渡</button>
    </div>

    <div class="container">
        <div id="map-wrapper">
            <div class="zoom-controls">
                <button class="zoom-btn" onclick="manualZoom(1.5)">＋</button>
                <button class="zoom-btn" onclick="manualZoom(0.5)">－</button>
            </div>
            
            <svg id="main-map-svg" viewBox="0 0 800 600" xmlns="http://www.w3.org/2000/svg">
                <rect width="800" height="600" fill="#0e0e0e"/>
                <text x="50%" y="50%" text-anchor="middle" fill="#444">ここにSVGコードを貼り付けてください</text>
            </svg>
        </div>

        <div id="info-panel">
            <div id="save-bar">
                <p style="margin:0 0 5px 0; font-size:12px; color:#ddd;">未保存の変更があります</p>
                <button class="btn-save" onclick="saveAllChanges()">変更をサーバーに保存</button>
            </div>

            <h3 id="panel-title">エリア情報</h3>
            <div id="area-details">
                <p>地図上の領域を選択してください。</p>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/svg-pan-zoom@3.6.1/dist/svg-pan-zoom.min.js"></script>
    
    <script>
        // ▼▼▼ GASのURLを貼り付け ▼▼▼
        const GAS_API_URL = '【GASのウェブアプリURLをここに貼り付け】'; 

        let currentUser = null;
        let baseMapData = {};   
        let policyData = {};    
        let actionData = {};    
        let pendingUpdates = {}; // 未保存の変更を溜めておく場所 { "ID": 1, "ID2": 0 }
        let currentMode = 'normal';
        let panZoomInstance = null;

        // 初期化
        document.addEventListener('DOMContentLoaded', () => {
            fetch(GAS_API_URL + '?op=getCountryList')
                .then(res => res.json())
                .then(json => {
                    if(json.status === 'success'){
                        const select = document.getElementById('country-select');
                        json.data.forEach(c => {
                            const opt = document.createElement('option');
                            opt.value = c; opt.textContent = c;
                            select.appendChild(opt);
                        });
                        document.getElementById('loading-msg').style.display = 'none';
                        document.getElementById('login-form').style.display = 'block';
                    }
                });
        });

        // ログイン
        function tryLogin() {
            const country = document.getElementById('country-select').value;
            const password = document.getElementById('password-input').value;
            fetch(`${GAS_API_URL}?op=login&country=${encodeURIComponent(country)}&password=${encodeURIComponent(password)}`)
                .then(res => res.json())
                .then(json => {
                    if(json.status === 'success') {
                        currentUser = country;
                        document.getElementById('user-display').textContent = '所属: ' + currentUser;
                        document.getElementById('login-modal').style.display = 'none';
                        loadBaseData(); 
                    } else { alert('認証失敗'); }
                });
        }

        function loadBaseData() {
            fetch(GAS_API_URL + '?op=getMapData')
                .then(res => res.json())
                .then(json => {
                    if(json.status === 'success') {
                        baseMapData = json.data;
                        setTimeout(() => {
                            initMapSystem();
                            if(currentMode === 'normal') renderMapColor(baseMapData);
                        }, 100);
                    }
                });
        }

        // モード切替
        function switchMode(mode) {
            document.querySelectorAll('.button-bar button').forEach(b => b.classList.remove('active'));
            
            // モード切替時に未保存データがあれば警告してもいいが、今回は簡易的に保持したままにする
            
            if (mode === 'policy') {
                document.getElementById('btn-policy').classList.add('active');
                currentMode = 'policy';
                document.getElementById('panel-title').textContent = '経済政策レポート';
                
                Promise.all([
                    fetch(`${GAS_API_URL}?op=getPolicyData&country=${encodeURIComponent(currentUser)}`).then(r=>r.json()),
                    fetch(`${GAS_API_URL}?op=getActionData`).then(r=>r.json())
                ]).then(([pRes, aRes]) => {
                    policyData = pRes.data;
                    // サーバーデータ + 未保存データ をマージして最新の状態を作る
                    actionData = { ...aRes.data, ...pendingUpdates };
                    
                    renderHeatmap(policyData, actionData);
                    updateSaveBar(); // 保存ボタンの表示判定
                    document.getElementById('area-details').innerHTML = '<p>経済指標モード：<br>D列の値により色分け。<br>黄色枠は政策実行中。</p>';
                });

            } else {
                document.getElementById('btn-' + mode).classList.add('active');
                currentMode = 'normal';
                document.getElementById('panel-title').textContent = 'エリア情報';
                renderMapColor(baseMapData);
                document.getElementById('area-details').innerHTML = `<p>${mode}機能は準備中です。</p>`;
                // 通常モードでは枠線を全てリセット
                const svg = document.querySelector('#map-wrapper svg');
                svg.querySelectorAll('path, circle, rect, polygon').forEach(p => {
                    p.style.stroke = "#000"; p.style.strokeWidth = "0.2px";
                });
            }
        }

        // ヒートマップ描画
        function renderHeatmap(pData, aData) {
            const svgElement = document.querySelector('#map-wrapper svg');
            if(!svgElement) return;

            // 他国領を暗く
            svgElement.querySelectorAll('path, circle, rect, polygon').forEach(p => {
                p.style.fill = '#111';
                p.style.stroke = '#222';
                p.style.strokeWidth = '0.2px';
            });

            // 色計算
            let minVal = 999999, maxVal = -999999;
            for(const key in pData) {
                const val = pData[key]._Value;
                if(val < minVal) minVal = val;
                if(val > maxVal) maxVal = val;
            }
            if(maxVal === minVal) maxVal = minVal + 1;

            // 自国領の描画
            for (const [id, info] of Object.entries(pData)) {
                try {
                    const target = document.getElementById(id) || svgElement.querySelector('#' + CSS.escape(id));
                    if (target) {
                        const val = info._Value;
                        const ratio = (val - minVal) / (maxVal - minVal);
                        const hue = Math.floor(ratio * 120); 
                        target.style.fill = `hsl(${hue}, 70%, 40%)`;

                        // 枠線（pendingUpdatesも考慮済み）
                        if (aData[id] === 1) {
                            target.style.stroke = "#FFD700"; // Gold
                            target.style.strokeWidth = "1.5px"; // ★太すぎないように修正
                            target.parentNode.appendChild(target); 
                        } else {
                            target.style.stroke = "#fff";
                            target.style.strokeWidth = "0.2px";
                        }
                    }
                } catch(e) {}
            }
        }

        function renderMapColor(data) {
            const svgElement = document.querySelector('#map-wrapper svg');
            for (const [id, info] of Object.entries(data)) {
                try {
                    const target = document.getElementById(id) || svgElement.querySelector('#' + CSS.escape(id));
                    if (target) {
                        target.style.fill = info.Color || '#333';
                        target.style.stroke = "#000";
                        target.style.strokeWidth = "0.2px";
                    }
                } catch(e) {}
            }
        }

        function initMapSystem() {
            const svgElement = document.querySelector('#map-wrapper svg');
            if (!svgElement) return;
            if (!svgElement.id) svgElement.id = 'main-map-svg';

            // 背景修正：黒以外のrectを削除
            const rects = svgElement.querySelectorAll('rect');
            rects.forEach(rect => {
                if (rect.getAttribute('width') && rect.getAttribute('height')) {
                    const fill = rect.getAttribute('fill') || rect.style.fill;
                    if (fill !== '#0e0e0e') {
                        rect.remove(); 
                    }
                }
            });

            if(!panZoomInstance) {
                panZoomInstance = svgPanZoom('#' + svgElement.id, {
                    zoomEnabled: true, controlIconsEnabled: false,
                    fit: true, center: true, minZoom: 0.1, maxZoom: 50, dblClickZoomEnabled: false
                });
            }

            svgElement.addEventListener('pointerdown', (e) => {
                const target = e.target.closest('path, circle, rect, polygon');
                if (target && target.id) showInfo(target.id);
            });
        }

        function manualZoom(scale) {
            if (!panZoomInstance) return;
            if (scale > 1) panZoomInstance.zoomBy(1.2); else panZoomInstance.zoomBy(0.8);
        }

        // --- ローカルでの変更処理 ---
        function toggleActionLocal(id) {
            const currentVal = actionData[id] || 0;
            const newVal = currentVal === 1 ? 0 : 1;

            // 1. データを更新
            actionData[id] = newVal;
            
            // 2. 保存待ちリストに追加（上書き）
            pendingUpdates[id] = newVal;

            // 3. 画面再描画（通信せずに色だけ変える）
            renderHeatmap(policyData, actionData);
            
            // 4. 情報パネル更新
            showInfo(id);

            // 5. 保存ボタン表示判定
            updateSaveBar();
        }

        // --- サーバーへ一括保存 ---
        function saveAllChanges() {
            const btn = document.querySelector('.btn-save');
            btn.textContent = '保存中...';
            btn.disabled = true;

            const payload = JSON.stringify(pendingUpdates);

            fetch(`${GAS_API_URL}?op=bulkUpdateActionData&updates=${encodeURIComponent(payload)}`)
                .then(res => res.json())
                .then(json => {
                    if(json.status === 'success') {
                        // 保存成功
                        pendingUpdates = {}; // 未保存リストをクリア
                        updateSaveBar();
                        alert('すべての変更を保存しました');
                    } else {
                        alert('保存エラー: ' + json.message);
                        btn.textContent = '変更をサーバーに保存';
                        btn.disabled = false;
                    }
                })
                .catch(err => {
                    alert('通信エラー');
                    btn.textContent = '変更をサーバーに保存';
                    btn.disabled = false;
                });
        }

        function updateSaveBar() {
            const bar = document.getElementById('save-bar');
            // 未保存のキーが一つでもあるか
            if (Object.keys(pendingUpdates).length > 0) {
                bar.style.display = 'block';
            } else {
                bar.style.display = 'none';
            }
        }

        function showInfo(id) {
            const infoBox = document.getElementById('area-details');
            let targetData = null;
            let html = `<p style="font-size:1.1em; color:#fff; border-bottom:1px solid #555; padding-bottom:5px;"><b>${id}</b></p>`;

            // 枠線リセット＆再設定
            const svgElement = document.querySelector('#map-wrapper svg');
            svgElement.querySelectorAll('path, circle, rect, polygon').forEach(p => {
                if(currentMode === 'policy') {
                     // 経済モード：黄色(1.5px) or 白(0.2px)
                     if(actionData[p.id] === 1 && policyData[p.id]) {
                         p.style.stroke = "#FFD700"; p.style.strokeWidth = "1.5px";
                     } else if (policyData[p.id]) {
                         p.style.stroke = "#fff"; p.style.strokeWidth = "0.2px";
                     } else {
                         p.style.stroke = "#222"; p.style.strokeWidth = "0.2px";
                     }
                } else {
                    p.style.stroke = "#000"; p.style.strokeWidth = "0.2px";
                }
            });
            // 選択中の強調（2.5px）
            const targetEl = document.getElementById(id) || svgElement.querySelector('#' + CSS.escape(id));
            if(targetEl) {
                targetEl.style.stroke = "#ffffff";
                targetEl.style.strokeWidth = "2.5px"; // ★強調を少し抑えめに
                targetEl.parentNode.appendChild(targetEl); 
            }

            if (currentMode === 'policy') {
                targetData = policyData[id];
                if (targetData) {
                    const isActive = actionData[id] === 1;
                    const btnText = isActive ? '経済政策を取り消す' : 'このステートで経済政策を行う';
                    const btnClass = isActive ? 'btn-cancel' : 'btn-do';
                    // ここで toggleActionLocal を呼ぶ
                    html += `<button class="action-btn ${btnClass}" onclick="toggleActionLocal('${id}')">${btnText}</button>`;
                }
            } else {
                targetData = baseMapData[id];
            }

            if (targetData) {
                html += `<table style="width:100%; font-size:14px; color:#ccc; border-collapse:collapse;">`;
                for (const [key, val] of Object.entries(targetData)) {
                    if(key !== 'ID' && key !== '_Value') {
                        html += `<tr style="border-bottom:1px solid #333;"><td style="width:40%; color:#888; padding:8px 0;">${key}</td><td style="padding:8px 0;">${val}</td></tr>`;
                    }
                }
                html += `</table>`;
            } else {
                html += `<p>詳細データなし</p>`;
            }
            
            infoBox.innerHTML = html;
        }
    </script>
</body>
</html>
