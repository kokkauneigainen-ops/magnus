<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>貿易管理システム</title>
    <style>
        :root {
            --bg-dark: rgba(20, 20, 30, 0.95);
            --card-bg: #1e1e24;
            --accent: #ff9800; /* 貿易っぽいオレンジ */
            --green: #4caf50;
            --red: #f44336;
            --text: #e0e0e0;
            --border: #444;
        }

        body {
            margin: 0;
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background: url('back.jpg') no-repeat center center fixed;
            background-size: cover;
            color: var(--text);
            min-height: 100vh;
            padding-bottom: 80px; /* FAB用スペース */
        }

        /* ヘッダー */
        header {
            background: var(--bg-dark);
            padding: 10px 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 2px solid var(--accent);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-left { display: flex; align-items: center; }
        .back-btn {
            background: transparent;
            border: 1px solid var(--accent);
            color: var(--accent);
            padding: 5px 10px;
            border-radius: 5px;
            text-decoration: none;
            font-size: 0.8rem;
            margin-right: 15px;
        }
        header h1 { font-size: 1rem; margin: 0; }
        .resource-status { font-size: 0.7rem; color: #aaa; margin-top: 5px;}

        /* カードデザイン */
        .container { max-width: 800px; margin: 20px auto; padding: 10px; }
        
        .trade-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-left: 5px solid #888;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            position: relative;
        }

        /* ステータス別の色 */
        .status-未選択 { border-left-color: #ffd700; } /* 黄色 */
        .status-認可 { border-left-color: var(--green); }
        .status-拒否 { border-left-color: var(--red); opacity: 0.7; }

        .card-header {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: #aaa;
            margin-bottom: 10px;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
        }

        .trade-type-badge {
            background: var(--accent);
            color: #000;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.7rem;
        }

        .trade-details {
            display: flex;
            justify-content: space-between;
            background: rgba(0,0,0,0.2);
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 0.9rem;
        }
        
        .trade-arrow { font-weight: bold; color: var(--accent); align-self: center;}
        
        .detail-box { text-align: center; width: 45%; }
        .detail-label { font-size: 0.7rem; color: #888; display: block; }
        .detail-val { font-weight: bold; color: white; }

        .card-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            border-top: 1px solid #333;
            padding-top: 10px;
        }

        .btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            color: white;
        }
        .btn-approve { background: var(--green); }
        .btn-reject { background: var(--red); }
        .btn-disabled { background: #555; cursor: not-allowed; opacity: 0.5; }

        /* FAB */
        .fab {
            position: fixed; right: 20px; bottom: 20px;
            width: 60px; height: 60px;
            background: var(--accent);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 30px; color: white;
            cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            border: none; z-index: 500;
        }

        /* モーダル */
        #modal {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 1000;
            overflow-y: auto;
        }
        .modal-content {
            background: #222;
            width: 90%; max-width: 500px;
            margin: 20px auto; padding: 20px;
            border-radius: 10px; position: relative;
        }
        .modal-content input, .modal-content select, .modal-content textarea {
            width: 100%; margin: 5px 0 15px 0; padding: 10px;
            background: #333; border: 1px solid var(--border);
            color: white; box-sizing: border-box;
        }
        label { font-size: 0.8rem; color: var(--accent); }
        
        .limit-alert { color: var(--red); font-size: 0.8rem; display: none; }
    </style>
</head>
<body>

<header>
    <div class="header-left">
        <a href="home.html" class="back-btn">◀ 戻る</a>
        <div>
            <h1>貿易管理</h1>
            <div id="country-display" style="font-size:0.8rem;">Loading...</div>
        </div>
    </div>
</header>

<div class="container" id="trade-list">
    <p style="text-align: center;">データを取得中...</p>
</div>

<button class="fab" onclick="toggleModal(true)">＋</button>

<div id="modal">
    <div class="modal-content">
        <span style="position:absolute; right:15px; top:10px; cursor:pointer; font-size:20px;" onclick="toggleModal(false)">×</span>
        <h3>新規貿易申請</h3>

        <label>宛先国</label>
        <select id="toCountry"></select>

        <label>取引種別</label>
        <select id="tradeType">
            <option value="交易路建設">交易路建設</option>
            <option value="一時的交換">一時的交換</option>
            <option value="価格変更">価格変更</option>
        </select>

        <div style="display:flex; gap:10px;">
            <div style="flex:1;">
                <label>提示(あげる)</label>
                <select id="offerItem" onchange="checkLimit()">
                    </select>
                <input type="number" id="offerQty" placeholder="数量" oninput="checkLimit()">
                <div id="limit-msg" class="limit-alert">保有上限を超えています！</div>
            </div>
            <div style="flex:1;">
                <label>要求(もらう)</label>
                <select id="reqItem">
                    </select>
                <input type="number" id="reqQty" placeholder="数量">
            </div>
        </div>

        <label>件名</label>
        <input type="text" id="tradeTitle" placeholder="取引の要件">
        
        <label>詳細・備考</label>
        <textarea id="tradeBody" rows="4"></textarea>

        <button class="btn btn-approve" id="send-btn" onclick="sendTrade()">申請を送る</button>
    </div>
</div>

<script>
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbwXxJCNjLAQbFq5swm7L_-tLmra9lgAlOSLeUq_B1LfhxqDhWwrV9uQ7nCdzajbdgcwEg/exec';
    
    const myCountry = sessionStorage.getItem('loginCountry') || '未ログイン';
    const resourcesList = ['自国通貨', '金属資源', '鉱山資源', '食糧資源', '民需資源', '軍需資源'];
    let myResourceData = {}; // 保有量データ

    window.onload = () => {
        document.getElementById('country-display').innerText = myCountry;
        initForm();
        fetchTrades();
    };

    function initForm() {
        // 資源セレクトボックスの生成
        const opts = resourcesList.map(r => `<option value="${r}">${r}</option>`).join('');
        document.getElementById('offerItem').innerHTML = opts;
        document.getElementById('reqItem').innerHTML = opts;
    }

    function toggleModal(show) {
        document.getElementById('modal').style.display = show ? 'block' : 'none';
    }

    // データ取得
    async function fetchTrades() {
        try {
            const res = await fetch(`${GAS_URL}?country=${encodeURIComponent(myCountry.trim())}`);
            const data = await res.json();
            
            myResourceData = data.resources; // 自分の資源上限を保存
            renderTrades(data.trades);
            renderCountrySelect(data.countries);

        } catch (e) {
            console.error(e);
            document.getElementById('trade-list').innerText = '読み込みエラー';
        }
    }

    // 貿易リスト描画
    function renderTrades(trades) {
        const container = document.getElementById('trade-list');
        container.innerHTML = '';

        if (trades.length === 0) {
            container.innerHTML = '<p style="text-align:center;">取引履歴はありません。</p>';
            return;
        }

        trades.forEach(t => {
            const isReceiver = (t.receiver === myCountry); // 自分が受信側か
            const isPending = (t.status === '未選択');

            // カード生成
            const div = document.createElement('div');
            div.className = `trade-card status-${t.status}`;
            
            let actions = '';
            // 受信側 かつ 未選択の場合のみ、ボタンを表示
            if (isReceiver && isPending) {
                actions = `
                    <div class="card-actions">
                        <button class="btn btn-approve" onclick="updateStatus('${t.id}', '認可')">認可</button>
                        <button class="btn btn-reject" onclick="updateStatus('${t.id}', '拒否')">拒否</button>
                    </div>
                `;
            } else {
                actions = `<div style="text-align:right; margin-top:10px; font-size:0.8rem;">ステータス: <b>${t.status}</b></div>`;
            }

            div.innerHTML = `
                <div class="card-header">
                    <span>${t.date}</span>
                    <span class="trade-type-badge">${t.type}</span>
                </div>
                <div style="font-weight:bold; margin-bottom:5px;">${t.title}</div>
                <div style="font-size:0.8rem; color:#ccc;">From: ${t.sender} → To: ${t.receiver}</div>
                
                <div class="trade-details">
                    <div class="detail-box">
                        <span class="detail-label">提示</span>
                        <div class="detail-val">${t.offerItem}<br>${t.offerQty}</div>
                    </div>
                    <div class="trade-arrow">➡</div>
                    <div class="detail-box">
                        <span class="detail-label">要求</span>
                        <div class="detail-val">${t.reqItem}<br>${t.reqQty}</div>
                    </div>
                </div>
                
                <div style="white-space:pre-wrap; font-size:0.9rem;">${t.body}</div>
                ${actions}
            `;
            container.appendChild(div);
        });
    }

    function renderCountrySelect(countries) {
        const select = document.getElementById('toCountry');
        select.innerHTML = '';
        countries.forEach(c => {
            if (c !== myCountry) {
                const opt = document.createElement('option');
                opt.value = c;
                opt.textContent = c;
                select.appendChild(opt);
            }
        });
    }

    // 上限チェック
    function checkLimit() {
        const item = document.getElementById('offerItem').value;
        const qty = parseFloat(document.getElementById('offerQty').value) || 0;
        const limit = myResourceData[item] || 0;
        
        const msg = document.getElementById('limit-msg');
        const btn = document.getElementById('send-btn');

        if (qty > limit) {
            msg.style.display = 'block';
            msg.innerText = `上限(${limit})を超えています`;
            btn.disabled = true;
            btn.classList.add('btn-disabled');
        } else {
            msg.style.display = 'none';
            btn.disabled = false;
            btn.classList.remove('btn-disabled');
        }
    }

    // 申請送信
    async function sendTrade() {
        const receiver = document.getElementById('toCountry').value;
        const type = document.getElementById('tradeType').value;
        const offerItem = document.getElementById('offerItem').value;
        const offerQty = document.getElementById('offerQty').value;
        const reqItem = document.getElementById('reqItem').value;
        const reqQty = document.getElementById('reqQty').value;
        const title = document.getElementById('tradeTitle').value;
        const body = document.getElementById('tradeBody').value;

        if (!title || !offerQty || !reqQty) return alert('必須項目を入力してください');

        // 再度バリデーション
        if (parseFloat(offerQty) > (myResourceData[offerItem] || 0)) {
            return alert('保有資源の上限を超えています');
        }

        const payload = {
            action: 'create',
            sender: myCountry,
            receiver: receiver,
            type: type,
            offerItem: offerItem,
            offerQty: offerQty,
            reqItem: reqItem,
            reqQty: reqQty,
            title: title,
            body: body
        };

        const btn = document.getElementById('send-btn');
        btn.disabled = true;
        btn.innerText = "送信中...";

        try {
            await fetch(GAS_URL, {
                method: 'POST',
                body: JSON.stringify(payload)
            });
            alert('申請しました');
            toggleModal(false);
            fetchTrades();
        } catch(e) {
            alert('送信失敗');
        } finally {
            btn.disabled = false;
            btn.innerText = "申請を送る";
        }
    }

    // ステータス更新（認可・拒否）
    async function updateStatus(id, newStatus) {
        if (!confirm(`この取引を「${newStatus}」しますか？`)) return;

        try {
            await fetch(GAS_URL, {
                method: 'POST',
                body: JSON.stringify({
                    action: 'update',
                    id: id,
                    status: newStatus
                })
            });
            alert('更新しました');
            fetchTrades(); // リロード
        } catch(e) {
            alert('更新失敗');
        }
    }
</script>

</body>
</html>
