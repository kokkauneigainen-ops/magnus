<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>貿易管理システム</title>
    <style>
        :root {
            --bg-dark: rgba(20, 20, 30, 0.95);
            --card-bg: #1e1e24;
            --accent: #ff9800; 
            --green: #4caf50;
            --red: #f44336;
            --blue: #2196f3;
            --text: #e0e0e0;
            --border: #444;
        }

        body {
            margin: 0;
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background: url('back.jpg') no-repeat center center fixed;
            background-size: cover;
            color: var(--text);
            min-height: 100vh;
            padding-bottom: 80px;
        }

        header {
            background: var(--bg-dark);
            padding: 10px 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 2px solid var(--accent);
            position: sticky; top: 0; z-index: 100;
        }
        .header-left { display: flex; align-items: center; }
        .back-btn {
            background: transparent; border: 1px solid var(--accent);
            color: var(--accent); padding: 5px 10px; border-radius: 5px;
            text-decoration: none; font-size: 0.8rem; margin-right: 15px;
        }
        header h1 { font-size: 1rem; margin: 0; }

        .container { max-width: 800px; margin: 20px auto; padding: 10px; }
        
        .trade-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-left: 5px solid #888;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .status-未選択 { border-left-color: #ffd700; }
        .status-認可 { border-left-color: var(--green); }
        .status-拒否 { border-left-color: var(--red); opacity: 0.7; }
        .status-資源不足により拒否 { border-left-color: #999; background: #2a1a1a; } /* 専用スタイル */

        .type-badge {
            padding: 2px 6px; border-radius: 4px;
            font-weight: bold; font-size: 0.7rem; color: #000;
            background: #ccc;
        }
        .type-建設 { background: var(--accent); }
        .type-交換 { background: var(--green); }
        .type-価格変更 { background: var(--blue); color: white; }

        .card-header {
            display: flex; justify-content: space-between;
            font-size: 0.8rem; color: #aaa;
            margin-bottom: 10px; border-bottom: 1px solid #333;
            padding-bottom: 5px;
        }

        .trade-details {
            display: flex; justify-content: space-between;
            background: rgba(0,0,0,0.2); padding: 10px;
            border-radius: 5px; margin: 10px 0; font-size: 0.9rem;
        }
        .trade-arrow { font-weight: bold; color: var(--accent); align-self: center;}
        .detail-box { text-align: center; width: 45%; }
        .detail-val { font-weight: bold; color: white; }
        .detail-label { font-size: 0.7rem; color: #888; display: block; }

        .card-actions {
            display: flex; gap: 10px; margin-top: 15px;
            border-top: 1px solid #333; padding-top: 10px;
        }
        .btn {
            flex: 1; padding: 10px; border: none; border-radius: 5px;
            font-weight: bold; cursor: pointer; color: white;
        }
        .btn-approve { background: var(--green); }
        .btn-reject { background: var(--red); }
        .btn-disabled { background: #555; cursor: not-allowed; opacity: 0.5; }

        .fab {
            position: fixed; right: 20px; bottom: 20px;
            width: 60px; height: 60px; background: var(--accent);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 30px; color: white; cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5); border: none; z-index: 500;
        }

        #modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 1000; overflow-y: auto;
        }
        .modal-content {
            background: #222; width: 90%; max-width: 500px;
            margin: 20px auto; padding: 20px; border-radius: 10px; position: relative;
        }
        .modal-content input, .modal-content select, .modal-content textarea {
            width: 100%; margin: 5px 0 15px 0; padding: 10px;
            background: #333; border: 1px solid var(--border);
            color: white; box-sizing: border-box;
        }
        
        /* 警告メッセージ用 */
        .limit-alert { color: var(--red); font-size: 0.8rem; display: none; margin-top: -10px; margin-bottom: 10px; font-weight: bold; }
        .hidden { display: none; }
    </style>
</head>
<body>

<header>
    <div class="header-left">
        <a href="home.html" class="back-btn">◀ 戻る</a>
        <div>
            <h1>貿易管理</h1>
            <div id="country-display" style="font-size:0.8rem;">Loading...</div>
        </div>
    </div>
</header>

<div class="container" id="trade-list">
    <p style="text-align: center;">データを取得中...</p>
</div>

<button class="fab" onclick="toggleModal(true)">＋</button>

<div id="modal">
    <div class="modal-content">
        <span style="position:absolute; right:15px; top:10px; cursor:pointer; font-size:20px;" onclick="toggleModal(false)">×</span>
        <h3>新規貿易・変更申請</h3>

        <label>取引種別</label>
        <select id="tradeType" onchange="handleTypeChange()">
            <option value="交易路建設">交易路建設</option>
            <option value="一時的交換">一時的交換</option>
            <option value="価格変更">価格変更（既存ルートの修正）</option>
        </select>

        <div id="routeSelectContainer" class="hidden">
            <label style="color:var(--blue);">対象の交易路を選択</label>
            <select id="targetRoute" onchange="fillRouteData()">
                <option value="">選択してください</option>
            </select>
        </div>

        <label>宛先国</label>
        <select id="toCountry" onchange="checkAllLimits()"></select>

        <div style="display:flex; gap:10px;">
            <div style="flex:1;">
                <label id="lbl-offer">提示(あげる)</label>
                <select id="offerItem" onchange="checkAllLimits()"></select>
                <input type="number" id="offerQty" placeholder="数量" oninput="checkAllLimits()">
                <div id="offer-alert" class="limit-alert">あなたの資源が足りません</div>
            </div>
            <div style="flex:1;">
                <label id="lbl-req">要求(もらう)</label>
                <select id="reqItem" onchange="checkAllLimits()"></select>
                <input type="number" id="reqQty" placeholder="数量" oninput="checkAllLimits()">
                <div id="req-alert" class="limit-alert">相手の資源が足りません</div>
            </div>
        </div>

        <label>件名</label>
        <input type="text" id="tradeTitle" placeholder="取引の要件">
        
        <label>詳細・備考</label>
        <textarea id="tradeBody" rows="4" placeholder="詳細を記入してください"></textarea>

        <button class="btn btn-approve" id="send-btn" onclick="sendTrade()">申請を送る</button>
    </div>
</div>

<script>
    // ★GASのウェブアプリURL★
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbx43pFiX-ljHoDK_XP4NP84MQLdpBq9mV9f_RUlg68l9j9RiPBlvM3MVGj8s_VyR8Q3RQ/exec'; 
    const myCountry = sessionStorage.getItem('loginCountry') || '未ログイン';
    
    const resourcesList = ['自国通貨', '金属資源', '鉱山資源', '食糧資源', '燃料資源', '民需資源', '軍需資源'];
    
    // ★全国家の資源データを保持する変数
    let allResourcesMap = {}; 
    let activeRoutesData = [];

    window.onload = () => {
        document.getElementById('country-display').innerText = myCountry;
        initForm();
        fetchTrades();
    };

    function initForm() {
        const opts = resourcesList.map(r => `<option value="${r}">${r}</option>`).join('');
        document.getElementById('offerItem').innerHTML = opts;
        document.getElementById('reqItem').innerHTML = opts;
    }

    // 種別変更
    function handleTypeChange() {
        const type = document.getElementById('tradeType').value;
        const routeContainer = document.getElementById('routeSelectContainer');
        const toCountrySelect = document.getElementById('toCountry');
        const lblOffer = document.getElementById('lbl-offer');
        const lblReq = document.getElementById('lbl-req');

        if (type === '価格変更') {
            routeContainer.classList.remove('hidden');
            toCountrySelect.disabled = true;
            lblOffer.innerText = "新:提示量 (あなたの支出)";
            lblReq.innerText = "新:要求量 (相手の支出)";
            updateRouteSelectOptions();
        } else {
            routeContainer.classList.add('hidden');
            toCountrySelect.disabled = false;
            // リセットするとバリデーションが走るので値を保持しつつチェック
            lblOffer.innerText = "提示 (あげる)";
            lblReq.innerText = "要求 (もらう)";
        }
        checkAllLimits();
    }

    function updateRouteSelectOptions() {
        const select = document.getElementById('targetRoute');
        select.innerHTML = '<option value="">選択してください</option>';
        if (activeRoutesData.length === 0) {
            const opt = document.createElement('option');
            opt.text = "変更可能な交易路がありません";
            select.appendChild(opt);
            return;
        }
        activeRoutesData.forEach(route => {
            const partner = (route.sender === myCountry) ? route.receiver : route.sender;
            let myGiveItem, myGiveQty, myGetItem, myGetQty;
            if (route.sender === myCountry) {
                myGiveItem = route.offerItem; myGiveQty = route.offerQty;
                myGetItem = route.reqItem; myGetQty = route.reqQty;
            } else {
                myGiveItem = route.reqItem; myGiveQty = route.reqQty;
                myGetItem = route.offerItem; myGetQty = route.offerQty;
            }
            const opt = document.createElement('option');
            opt.value = JSON.stringify(route);
            opt.textContent = `対${partner}: ${myGiveItem}(${myGiveQty}) ➡ ${myGetItem}(${myGetQty})`;
            select.appendChild(opt);
        });
    }

    function fillRouteData() {
        const val = document.getElementById('targetRoute').value;
        if (!val) return;
        const route = JSON.parse(val);
        const partner = (route.sender === myCountry) ? route.receiver : route.sender;

        document.getElementById('toCountry').value = partner;
        if (route.sender === myCountry) {
            document.getElementById('offerItem').value = route.offerItem;
            document.getElementById('offerQty').value = route.offerQty;
            document.getElementById('reqItem').value = route.reqItem;
            document.getElementById('reqQty').value = route.reqQty;
        } else {
            document.getElementById('offerItem').value = route.reqItem;
            document.getElementById('offerQty').value = route.reqQty;
            document.getElementById('reqItem').value = route.offerItem;
            document.getElementById('reqQty').value = route.offerQty;
        }
        document.getElementById('tradeTitle').value = `価格変更: ${partner}との交易路`;
        checkAllLimits();
    }

    function toggleModal(show) {
        document.getElementById('modal').style.display = show ? 'block' : 'none';
        if(show) handleTypeChange();
    }

    async function fetchTrades() {
        try {
            const res = await fetch(`${GAS_URL}?country=${encodeURIComponent(myCountry.trim())}`);
            const data = await res.json();
            
            allResourcesMap = data.allResources; // ★全国家の資源データを保存
            activeRoutesData = data.activeRoutes;
            
            renderTrades(data.trades);
            renderCountrySelect(data.countries);
        } catch (e) {
            console.error(e);
            document.getElementById('trade-list').innerText = '読み込みエラー';
        }
    }

    function renderTrades(trades) {
        const container = document.getElementById('trade-list');
        container.innerHTML = '';

        if (trades.length === 0) {
            container.innerHTML = '<p style="text-align:center;">取引履歴はありません。</p>';
            return;
        }

        trades.forEach(t => {
            const isReceiver = (t.receiver === myCountry); 
            const isPending = (t.status === '未選択');
            let typeClass = 'type-建設';
            if (t.type.includes('交換')) typeClass = 'type-交換';
            if (t.type.includes('価格変更')) typeClass = 'type-価格変更';
            const displayType = t.type.split('（')[0];

            const div = document.createElement('div');
            // ステータスにスペースが含まれる場合の対策等は特に不要だが、資源不足などのクラスに対応
            div.className = `trade-card status-${t.status}`;
            
            let actions = '';
            if (isReceiver && isPending) {
                actions = `
                    <div class="card-actions">
                        <button class="btn btn-approve" onclick="updateStatus('${t.id}', '認可')">認可</button>
                        <button class="btn btn-reject" onclick="updateStatus('${t.id}', '拒否')">拒否</button>
                    </div>
                `;
            } else {
                actions = `<div style="text-align:right; margin-top:10px; font-size:0.8rem;">ステータス: <b>${t.status}</b></div>`;
            }

            div.innerHTML = `
                <div class="card-header">
                    <span>${t.date}</span>
                    <span class="type-badge ${typeClass}">${displayType}</span>
                </div>
                <div style="font-weight:bold; margin-bottom:5px;">${t.title}</div>
                <div style="font-size:0.8rem; color:#ccc;">From: ${t.sender} → To: ${t.receiver}</div>
                <div class="trade-details">
                    <div class="detail-box">
                        <span class="detail-label">提示</span>
                        <div class="detail-val">${t.offerItem}<br>${t.offerQty}</div>
                    </div>
                    <div class="trade-arrow">➡</div>
                    <div class="detail-box">
                        <span class="detail-label">要求</span>
                        <div class="detail-val">${t.reqItem}<br>${t.reqQty}</div>
                    </div>
                </div>
                <div style="white-space:pre-wrap; font-size:0.9rem;">${t.body}</div>
                ${actions}
            `;
            container.appendChild(div);
        });
    }

    function renderCountrySelect(countries) {
        // 価格変更などの際に値が消えないように、現在選択されている値を保存したいが
        // 頻繁にリロードされるわけではないので単純生成
        const select = document.getElementById('toCountry');
        const currentVal = select.value;
        select.innerHTML = '';
        countries.forEach(c => {
            if (c !== myCountry) {
                const opt = document.createElement('option');
                opt.value = c;
                opt.textContent = c;
                select.appendChild(opt);
            }
        });
        if(currentVal && Array.from(select.options).some(o => o.value === currentVal)){
             select.value = currentVal;
        }
    }

    // ★リソースチェック（自分 ＆ 相手）
    function checkAllLimits() {
        const offerItem = document.getElementById('offerItem').value;
        const offerQty = parseFloat(document.getElementById('offerQty').value) || 0;
        
        const reqItem = document.getElementById('reqItem').value;
        const reqQty = parseFloat(document.getElementById('reqQty').value) || 0;
        const toCountry = document.getElementById('toCountry').value;

        const offerAlert = document.getElementById('offer-alert');
        const reqAlert = document.getElementById('req-alert');
        const btn = document.getElementById('send-btn');
        let isValid = true;

        // 1. 自分の在庫チェック
        const myStock = (allResourcesMap[myCountry] && allResourcesMap[myCountry][offerItem]) || 0;
        if (offerQty > myStock) {
            offerAlert.style.display = 'block';
            offerAlert.innerText = `在庫不足 (保有: ${myStock})`;
            isValid = false;
        } else {
            offerAlert.style.display = 'none';
        }

        // 2. 相手の在庫チェック
        if (toCountry && allResourcesMap[toCountry]) {
            const partnerStock = allResourcesMap[toCountry][reqItem] || 0;
            if (reqQty > partnerStock) {
                reqAlert.style.display = 'block';
                reqAlert.innerText = `相手の在庫不足 (保有: ${partnerStock})`;
                isValid = false;
            } else {
                reqAlert.style.display = 'none';
            }
        } else {
            // 相手国未選択時などはチェックしない
            reqAlert.style.display = 'none';
        }

        if (!isValid) {
            btn.disabled = true;
            btn.classList.add('btn-disabled');
        } else {
            btn.disabled = false;
            btn.classList.remove('btn-disabled');
        }
    }

    async function sendTrade() {
        const receiver = document.getElementById('toCountry').value;
        const type = document.getElementById('tradeType').value;
        const offerItem = document.getElementById('offerItem').value;
        const offerQty = document.getElementById('offerQty').value;
        const reqItem = document.getElementById('reqItem').value;
        const reqQty = document.getElementById('reqQty').value;
        const title = document.getElementById('tradeTitle').value;
        let body = document.getElementById('tradeBody').value;

        if (type === '価格変更') {
            const routeVal = document.getElementById('targetRoute').value;
            if (routeVal) {
                const originalRoute = JSON.parse(routeVal);
                body += `\n\n[システム参照用: 元の交易路ID = ${originalRoute.id}]`;
            } else {
                return alert("変更する交易路を選択してください");
            }
        }

        if (!title || !offerQty || !reqQty) return alert('必須項目を入力してください');
        
        // 送信直前にも簡易チェック
        if(document.querySelector('.limit-alert[style*="block"]')) {
             return alert('資源不足のため送信できません');
        }

        const payload = {
            action: 'create',
            sender: myCountry,
            receiver: receiver,
            type: type,
            offerItem: offerItem,
            offerQty: offerQty,
            reqItem: reqItem,
            reqQty: reqQty,
            title: title,
            body: body
        };

        const btn = document.getElementById('send-btn');
        btn.disabled = true;
        btn.innerText = "送信中...";

        try {
            await fetch(GAS_URL, {
                method: 'POST',
                body: JSON.stringify(payload)
            });
            alert('申請しました');
            toggleModal(false);
            fetchTrades();
        } catch(e) {
            alert('送信失敗');
        } finally {
            btn.disabled = false;
            btn.innerText = "申請を送る";
        }
    }

    async function updateStatus(id, newStatus) {
        if (!confirm(`この取引を「${newStatus}」しますか？`)) return;

        try {
            const res = await fetch(GAS_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'update', id: id, status: newStatus })
            });
            const resultText = await res.text();
            
            if (resultText === '資源不足により拒否') {
                alert('【警告】どちらかの資源が不足しているため、システムにより「拒否」されました。');
            } else {
                alert('更新しました');
            }
            fetchTrades();
        } catch(e) {
            alert('更新失敗');
        }
    }
</script>

</body>
</html>
