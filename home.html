<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>国家運営処理システム・ステッラ</title>
    <style>
        /* --- 基本設定（ダークモード） --- */
        body {
            margin: 0; padding: 0;
            font-family: "HiraMinProN-W3", "Hiragino Mincho ProN", serif;
            background-color: #111; color: #e0e0e0;
            background-image: url('back.jpg');
            background-size: cover; background-position: center; background-attachment: fixed;
            min-height: 100vh; display: flex; flex-direction: column;
        }
        .overlay {
            background-color: rgba(0, 0, 0, 0.85); /* 全体を暗くするフィルター */
            flex: 1; display: flex; flex-direction: column; width: 100%;
        }

        /* --- 運営メッセージ --- */
        .admin-msg {
            background: rgba(80, 0, 0, 0.6); border-bottom: 1px solid #a00;
            color: #ffcccc; padding: 10px; text-align: center; font-size: 0.9rem;
            animation: pulse 3s infinite;
        }
        @keyframes pulse { 0% {background: rgba(80,0,0,0.6);} 50% {background: rgba(120,20,20,0.6);} 100% {background: rgba(80,0,0,0.6);} }

        /* --- 設定ボタンエリア --- */
        .settings-bar {
            display: flex; justify-content: flex-end; padding: 10px 20px;
        }
        .icon-btn {
            background: none; border: 1px solid #555; color: #aaa;
            padding: 5px 15px; border-radius: 20px; cursor: pointer; font-size: 0.8rem;
        }
        .icon-btn:hover { background: #333; color: #fff; border-color: #fff; }

        /* --- ヘッダー --- */
        header { text-align: center; padding: 20px 0; border-bottom: 1px solid #333; margin-bottom: 20px; }
        .logo { height: 60px; filter: drop-shadow(0 0 5px white); margin-bottom: 10px; }
        h1 { margin: 0; font-size: 1.8rem; letter-spacing: 0.1em; text-shadow: 0 0 10px black; }

        /* --- メインメニュー（ボタン群） --- */
        .menu-container {
            max-width: 1000px; margin: 0 auto; width: 95%; text-align: center; padding-bottom: 50px;
            display: none; /* ログイン後に表示 */
        }
        .welcome-text { font-size: 1.5rem; margin-bottom: 30px; font-weight: bold; }
        
        .grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;
        }
        /* リンクボタン */
        .app-link {
            display: flex; justify-content: center; align-items: center;
            background: rgba(30, 40, 50, 0.8); color: white; border: 1px solid #555;
            padding: 25px; text-decoration: none; font-size: 1.1rem;
            transition: 0.3s; box-shadow: 0 4px 5px rgba(0,0,0,0.5);
        }
        .app-link:hover {
            background: #3a506b; transform: translateY(-3px); box-shadow: 0 0 15px #3a506b;
        }

        /* --- フッター --- */
        footer { margin-top: auto; padding: 15px; text-align: center; color: #666; font-size: 0.8rem; border-top: 1px solid #222; }

        /* --- モーダル（ログイン・設定） --- */
        .modal-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 999;
            display: flex; justify-content: center; align-items: center;
            padding: 20px; box-sizing: border-box;
        }
        /* 設定モーダルは初期非表示 */
        #settings-modal { background: rgba(0,0,0,0.9); display: none; }

        .modal-content {
            background: #151515; border: 1px solid #444; padding: 40px 30px;
            width: 100%; max-width: 350px; text-align: center; position: relative;
            box-shadow: 0 0 40px rgba(255,255,255,0.05);
        }
        .modal-content h2 { margin-top: 0; border-bottom: 1px solid #333; padding-bottom: 10px; font-weight: normal; }
        
        input, select {
            width: 100%; padding: 12px; margin: 10px 0; background: #000;
            border: 1px solid #444; color: #fff; font-size: 1rem; box-sizing: border-box;
        }
        button.primary-btn {
            width: 100%; padding: 12px; margin-top: 20px; background: #333;
            color: #fff; border: 1px solid #666; cursor: pointer; transition: 0.3s;
        }
        button.primary-btn:hover { background: #555; border-color: #fff; }
        button.primary-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .close-x {
            position: absolute; top: 10px; right: 15px; background: none; border: none;
            color: #888; font-size: 1.5rem; cursor: pointer;
        }
        .status-msg { margin-top: 15px; font-size: 0.9rem; min-height: 1.2rem; color: #ff6b6b; }
        .ok-msg { color: #4caf50; }

        /* スマホ調整 */
        @media (max-width: 600px) { h1 {font-size: 1.4rem;} .logo {height: 40px;} }
    </style>
</head>
<body>

    <div id="login-modal" class="modal-bg">
        <div class="modal-content">
            <h2>認証システム</h2>
            <p style="text-align:left; font-size:0.9rem; margin:0;">所属国家</p>
            <select id="login-country">
                <option value="">読込中...</option>
            </select>
            
            <p style="text-align:left; font-size:0.9rem; margin:15px 0 0 0;">パスコード</p>
            <input type="password" id="login-pass" placeholder="Password">
            
            <button class="primary-btn" id="btn-login" onclick="execLogin()" disabled>接続待機中...</button>
            <div id="login-status" class="status-msg"></div>
        </div>
    </div>

    <div id="settings-modal" class="modal-bg">
        <div class="modal-content">
            <button class="close-x" onclick="toggleSettings(false)">×</button>
            <h2>パスワード変更</h2>
            
            <p style="text-align:left; font-size:0.9rem; margin:0;">新しいパスワード</p>
            <input type="text" id="new-pass" placeholder="英数字・日本語のみ">
            <input type="text" id="confirm-pass" placeholder="確認のため再入力">
            
            <button class="primary-btn" id="btn-change" onclick="execChangePass()">変更を保存</button>
            <div id="setting-status" class="status-msg"></div>
        </div>
    </div>

    <div class="overlay">
        <div class="admin-msg">
            【運営より】現在、開発途中です。㎰変更もできます。いろいろ試してみてください。
        </div>

        <div class="settings-bar">
            <button class="icon-btn" onclick="toggleSettings(true)">⚙ システム設定</button>
        </div>

        <header>
            <img src="stella.png" alt="Logo" class="logo" onerror="this.style.display='none'">
            <h1>国家運営処理システム<br>ステッラ</h1>
        </header>

        <div id="main-menu" class="menu-container">
            <div id="welcome-msg" class="welcome-text">ようこそ</div>
            
            <div class="grid">
                <a href="mailbox.html" class="app-link">メールボックス</a>
                <a href="index.html" class="app-link">ステート政策</a>
                <a href="action.html" class="app-link">政策</a>
                <a href="trade.html" class="app-link">貿易ターミナルへ</a>
                <a href="information.html" class="app-link">情報を見る</a>
                <a href="war.html" class="app-link">戦争システムへ</a>
                <a href="system.html" class="app-link">民営システムを見る</a>
            </div>
        </div>

        <footer>
            ※天オプの有志により作成されました
        </footer>
    </div>

    <script>

        const SHEET_ID = '1-UDU2Vm9fMu9Js4LjVvro_jNB96pM-tMvN8ufc7BkUU'; // シートID
        const GAS_URL  = 'https://script.google.com/macros/s/AKfycbwWG2Qs3cyDVX_3JseXmRepmDJzyWvPoNkhTwxu2wHUplUMEEUcsANtoMZ8u9dqw894/exec'; // GAS URL
        const SHEET_NAME = 'CountryData'; // タブ名


        let db = {}; // データ保持用
        let currentCountry = "";

        // 起動時の処理
        window.onload = async function() {
            const btn = document.getElementById('btn-login');
            const status = document.getElementById('login-status');
            
            try {
                // スプレッドシート読み込み (Visualization API)
                // キャッシュ回避のタイムスタンプ付き
                const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${SHEET_NAME}&t=${Date.now()}`;
                
                const res = await fetch(url);
                if(!res.ok) throw new Error("DB接続失敗");
                
                const text = await res.text();
                
                // エラー判定（HTMLが返ってきている場合など）
                if(text.trim().startsWith("<")) {
                    throw new Error("共有設定エラー: シートを「リンクを知っている全員」にしてください");
                }

                // CSV解析
                parseCSV(text);

                // 準備完了
                btn.disabled = false;
                btn.innerText = "接続開始";
                
            } catch(e) {
                console.error(e);
                status.innerText = e.message;
            }
        };

        // CSVをパースしてプルダウンを作る
        function parseCSV(csvText) {
            const rows = csvText.split(/\r?\n/);
            const select = document.getElementById('login-country');
            select.innerHTML = '<option value="">国家を選択してください</option>';

            rows.forEach((row, i) => {
                // 1行目(ヘッダー)は無視
                if(i === 0) return;
                
                // カンマ区切り＆ダブルクォート除去
                const cols = row.split(',').map(c => c.replace(/^"|"$/g, '').trim());
                
                // データがある行だけ処理 (A列=国名, B列=パス)
                if(cols.length >= 2 && cols[0]) {
                    db[cols[0]] = cols[1]; // メモリに保存
                    
                    const opt = document.createElement('option');
                    opt.value = cols[0];
                    opt.innerText = cols[0];
                    select.appendChild(opt);
                }
            });
        }

        // ログイン実行
        function execLogin() {
            const country = document.getElementById('login-country').value;
            const pass = document.getElementById('login-pass').value;
            const status = document.getElementById('login-status');

            if(!country) {
                status.innerText = "国家を選んでください";
                return;
            }

            if(db[country] === pass) {
                // 成功
                currentCountry = country;
                sessionStorage.setItem('loginCountry', country);
                document.getElementById('login-modal').style.display = 'none'; // モーダル消去
                document.getElementById('main-menu').style.display = 'block'; // メニュー表示
                document.getElementById('welcome-msg').innerText = `ようこそ、${country} 指導者様`;
            } else {
                status.innerText = "パスワードが違います";
                document.getElementById('login-pass').value = "";
            }
        }

        // 設定モーダルの開閉
        function toggleSettings(show) {
            const modal = document.getElementById('settings-modal');
            modal.style.display = show ? 'flex' : 'none';
            if(show) {
                // リセット
                document.getElementById('new-pass').value = "";
                document.getElementById('confirm-pass').value = "";
                document.getElementById('setting-status').innerText = "";
            }
        }

        // パスワード変更実行
        async function execChangePass() {
            const newPass = document.getElementById('new-pass').value;
            const confPass = document.getElementById('confirm-pass').value;
            const status = document.getElementById('setting-status');
            const btn = document.getElementById('btn-change');

            // バリデーション
            const regex = /^[a-zA-Z0-9\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]+$/;
            if(!newPass || !regex.test(newPass)) {
                status.innerText = "使用できない文字が含まれています";
                status.className = "status-msg";
                return;
            }
            if(newPass !== confPass) {
                status.innerText = "確認用パスワードが一致しません";
                status.className = "status-msg";
                return;
            }

            // 送信処理
            status.innerText = "サーバー通信中...";
            status.className = "status-msg";
            btn.disabled = true;

            try {
                // フォームデータ形式で送信（CORS対策に強い）
                const formData = new URLSearchParams();
                formData.append('country', currentCountry);
                formData.append('newPass', newPass);

                const res = await fetch(GAS_URL, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: formData
                });
                
                const json = await res.json();

                if(json.result === 'success') {
                    status.innerText = "変更しました！次回から有効です";
                    status.className = "status-msg ok-msg";
                    db[currentCountry] = newPass; // ローカルも更新
                    setTimeout(() => toggleSettings(false), 2000);
                } else {
                    throw new Error(json.message);
                }

            } catch(e) {
                console.error(e);
                status.innerText = "送信完了(確認中)... エラー表示でも変更されている可能性があります";
                // GASは成功していても通信経路の問題でエラーに見えることがあるため、
                // 致命的なエラー以外は「完了」扱いにする手もありますが、今回は正直に表示します
            } finally {
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
