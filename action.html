<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>National Policy Action</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-color: #121212;
            --text-color: #e0e0e0;
            --panel-bg: #1e1e1e;
            --accent-green: #4caf50;
            --accent-red: #f44336;
            --accent-blue: #2196f3;
            --heavy-border: 2px solid #555;
        }

        body {
            background-color: var(--bg-color);
            background-image: url('back.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: var(--text-color);
            font-family: 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        /* オーバーレイで背景を暗くする */
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: -1;
        }

        header {
            width: 100%;
            padding: 15px;
            background: rgba(30, 30, 30, 0.9);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-sizing: border-box;
            border-bottom: 1px solid #444;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .user-info {
            display: flex;
            align-items: center;
            font-size: 1.2rem;
            font-weight: bold;
        }

        .user-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
            border: 2px solid var(--text-color);
        }

        .back-btn {
            background: #333;
            color: white;
            border: 1px solid #666;
            padding: 8px 15px;
            cursor: pointer;
            border-radius: 4px;
            text-decoration: none;
            font-size: 0.9rem;
        }

        .container {
            width: 95%;
            max-width: 600px;
            margin-top: 20px;
            padding-bottom: 50px;
        }

        .card {
            background: rgba(30, 30, 30, 0.9);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }

        h2 {
            margin-top: 0;
            font-size: 1.1rem;
            border-bottom: 1px solid #555;
            padding-bottom: 5px;
            margin-bottom: 10px;
        }

        /* インフレ表示 */
        #inflation-display {
            font-size: 2.5rem;
            font-weight: bold;
            text-align: center;
            text-shadow: 0 0 10px rgba(0,0,0,0.5);
        }

        /* ボタン群 */
        .action-btn {
            display: block;
            width: 100%;
            padding: 15px;
            margin-bottom: 15px;
            font-size: 1rem;
            font-weight: bold;
            color: white;
            background: linear-gradient(145deg, #333, #222);
            border: 1px solid #555;
            border-radius: 5px;
            cursor: pointer;
            text-align: center;
            transition: transform 0.1s;
        }

        .action-btn:active {
            transform: scale(0.98);
        }

        /* 国家総動員ボタン（重厚） */
        #btn-mobilize {
            background: linear-gradient(180deg, #5d0000, #2a0000);
            border: 3px double #ff4444;
            color: #ffcccc;
            font-family: serif;
            letter-spacing: 2px;
            text-shadow: 0 0 5px red;
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.2);
            margin-top: 30px;
        }
        #btn-mobilize:disabled {
            background: #333;
            border-color: #555;
            color: #777;
            text-shadow: none;
            box-shadow: inset 0 0 10px #000;
            cursor: not-allowed;
        }

        /* モーダル */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #222;
            border: 1px solid #555;
            padding: 20px;
            width: 90%;
            max-width: 400px;
            border-radius: 8px;
            position: relative;
        }

        .close {
            position: absolute;
            right: 15px;
            top: 10px;
            color: #aaa;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
        }

        .data-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            border-bottom: 1px dotted #444;
            padding-bottom: 4px;
        }

        input[type="number"] {
            width: 100%;
            padding: 10px;
            background: #111;
            border: 1px solid #555;
            color: white;
            font-size: 1.2rem;
            margin: 15px 0;
            box-sizing: border-box;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
        }

        .btn-confirm {
            flex: 2;
            background: var(--accent-blue);
            border: none;
            padding: 10px;
            color: white;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .btn-cancel {
            flex: 1;
            background: #555;
            border: none;
            padding: 10px;
            color: white;
            border-radius: 4px;
            cursor: pointer;
        }

        table.status-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.9rem;
        }
        
        table.status-table th, table.status-table td {
            border: 1px solid #444;
            padding: 8px;
            text-align: center;
        }
        
        table.status-table th {
            background: #333;
        }

        /* グラフコンテナ */
        .chart-container {
            position: relative;
            height: 200px;
            width: 100%;
        }
    </style>
</head>
<body>

<header>
    <div class="user-info">
        <img src="stella.png" alt="Icon" class="user-icon">
        <span id="country-name">Loading...</span>
    </div>
    <a href="home.html" class="back-btn">戻る</a>
</header>

<div class="container">
    <div class="card">
        <h2>インフレレベル</h2>
        <div id="inflation-display">--</div>
    </div>

    <div class="card">
        <h2>インフレ推移</h2>
        <div class="chart-container">
            <canvas id="chart-inflation"></canvas>
        </div>
    </div>

    <div class="card">
        <h2>経済力推移</h2>
        <div class="chart-container">
            <canvas id="chart-economy"></canvas>
        </div>
    </div>

    <button class="action-btn" onclick="openModal('industrial')">産業技術開発を行う</button>
    <button class="action-btn" onclick="openModal('military')">軍事技術開発を行う</button>
    <button class="action-btn" onclick="openModal('expansion')">軍拡を予定する</button>
    
    <button id="btn-mobilize" class="action-btn" onclick="confirmMobilization()">⚠ 国家総動員を行う ⚠</button>
</div>

<div id="tech-modal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('tech-modal')">&times;</span>
        <h2 id="tech-title">開発</h2>
        
        <div class="data-row">
            <span>現在の投資額:</span> <span id="tech-current-invest">0</span>
        </div>
        <div class="data-row">
            <span>これまでの投資額:</span> <span id="tech-total-invest">0</span>
        </div>
        <div class="data-row">
            <span>現在の技術力:</span> <span id="tech-level">0</span>
        </div>

        <p>投資額を入力 (Max 1000)</p>
        <input type="number" id="tech-input" min="0" max="1000" placeholder="0">

        <div class="modal-actions">
            <button class="btn-cancel" onclick="resetTechInvestment()">取り消し(0にする)</button>
            <button class="btn-confirm" onclick="submitTechInvestment()">決定</button>
        </div>
    </div>
</div>

<div id="expansion-modal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('expansion-modal')">&times;</span>
        <h2>軍拡状況</h2>
        
        <div class="data-row">
            <span>軍拡プール:</span> <span id="exp-pool">0</span>
        </div>
        <div class="data-row">
            <span>軍拡速度:</span> <span id="exp-speed">0</span>
        </div>

        <table class="status-table">
            <thead>
                <tr>
                    <th>現在の軍量</th>
                    <th>充足率</th>
                    <th>展開軍量</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td id="exp-amount">0</td>
                    <td id="exp-sufficiency">0%</td>
                    <td id="exp-deployed">0</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    // ▼ ここにデプロイしたGASのウェブアプリURLを貼ってください ▼
    const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbwJK5f9es7eQx85Ek72-FTiJ9K-aSMWATCDZhpDOTKFJO3BKnjAfeFNGoD2nH8gzY17Pg/exec';
    
    // セッション情報の確認
    const country = sessionStorage.getItem('loginCountry');
    if (!country) {
        window.location.href = 'home.html';
    }
    document.getElementById('country-name').textContent = country;

    // グローバル変数でデータを保持
    let currentData = null;
    let currentModalType = ''; // 'industrial' or 'military'

    // 初期ロード
    window.onload = loadData;

    async function loadData() {
        try {
            const response = await fetch(`${GAS_API_URL}?action=getData&country=${encodeURIComponent(country)}`);
            const data = await response.json();
            
            if (data.error) {
                alert('データ取得エラー: ' + data.error);
                return;
            }

            currentData = data;
            renderPage(data);
        } catch (e) {
            console.error(e);
            alert('通信エラーが発生しました');
        }
    }

    function renderPage(data) {
        // 1. インフレ表示
        const infl = Number(data.inflation);
        const inflEl = document.getElementById('inflation-display');
        inflEl.textContent = infl;

        // 色計算 (-100:青 -> 0:緑 -> 100:赤)
        let color = 'white';
        if (infl >= 0) {
            // 緑(0) -> 赤(100)
            const ratio = Math.min(infl / 100, 1);
            // 緑: rgb(76, 175, 80), 赤: rgb(244, 67, 54)
            // シンプルにRGB補間で計算
            color = `rgb(${76 + (244-76)*ratio}, ${175 + (67-175)*ratio}, ${80 + (54-80)*ratio})`;
        } else {
            // 緑(0) -> 青(-100)
            const ratio = Math.min(Math.abs(infl) / 100, 1);
            // 青: rgb(33, 150, 243)
            color = `rgb(${76 + (33-76)*ratio}, ${175 + (150-175)*ratio}, ${80 + (243-80)*ratio})`;
        }
        inflEl.style.color = color;

        // 2. グラフ描画
        drawChart('chart-inflation', 'インフレ推移', data.history_inflation, 'rgba(255, 99, 132, 1)');
        drawChart('chart-economy', '経済力', data.history_economy, 'rgba(54, 162, 235, 1)');

        // 3. 総動員ボタンの状態
        const mobBtn = document.getElementById('btn-mobilize');
        if (data.action.mobilized == 1) {
            mobBtn.disabled = true;
            mobBtn.textContent = "国家総動員 発令済み";
            mobBtn.style.borderStyle = "inset";
        }
    }

    function drawChart(canvasId, label, dataArray, color) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        // 日付ラベルは単純に1日目, 2日目...とするか、配列長から生成
        const labels = dataArray.map((_, i) => `Day ${i+1}`);
        
        // 既存チャートがあれば破棄（再描画時）
        if (window[canvasId] instanceof Chart) {
            window[canvasId].destroy();
        }

        window[canvasId] = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: label,
                    data: dataArray,
                    borderColor: color,
                    borderWidth: 2,
                    tension: 0.1,
                    pointRadius: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { display: false },
                    y: { 
                        grid: { color: '#333' },
                        ticks: { color: '#aaa' }
                    }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        });
    }

    // --- モーダル操作 ---

    function openModal(type) {
        const d = currentData.action;
        if (!d) return;

        if (type === 'industrial') {
            currentModalType = 'industrial';
            document.getElementById('tech-title').innerText = "産業技術開発";
            document.getElementById('tech-current-invest').innerText = d.ind_invest_now;
            document.getElementById('tech-total-invest').innerText = d.ind_invest_total;
            document.getElementById('tech-level').innerText = d.ind_tech;
            document.getElementById('tech-input').value = '';
            document.getElementById('tech-modal').style.display = 'flex';
        } else if (type === 'military') {
            currentModalType = 'military';
            document.getElementById('tech-title').innerText = "軍事技術開発";
            document.getElementById('tech-current-invest').innerText = d.mil_invest_now;
            document.getElementById('tech-total-invest').innerText = d.mil_invest_total;
            document.getElementById('tech-level').innerText = d.mil_tech;
            document.getElementById('tech-input').value = '';
            document.getElementById('tech-modal').style.display = 'flex';
        } else if (type === 'expansion') {
            document.getElementById('exp-pool').innerText = d.pool;
            document.getElementById('exp-speed').innerText = d.speed;
            document.getElementById('exp-amount').innerText = d.mil_amount;
            document.getElementById('exp-sufficiency').innerText = (d.sufficiency * 100).toFixed(1) + '%';
            document.getElementById('exp-deployed').innerText = d.deployed;
            document.getElementById('expansion-modal').style.display = 'flex';
        }
    }

    function closeModal(id) {
        document.getElementById(id).style.display = 'none';
    }

    // --- 送信処理 ---

    function submitTechInvestment() {
        const val = parseInt(document.getElementById('tech-input').value);
        if (isNaN(val) || val < 0 || val > 1000) {
            alert('0〜1000の範囲で入力してください');
            return;
        }
        
        const typeKey = currentModalType === 'industrial' ? 'invest_industrial' : 'invest_military';
        sendPost(typeKey, val);
        closeModal('tech-modal');
    }

    function resetTechInvestment() {
        const typeKey = currentModalType === 'industrial' ? 'invest_industrial' : 'invest_military';
        sendPost(typeKey, 0);
        closeModal('tech-modal');
    }

    function confirmMobilization() {
        if (confirm("【警告】\n国家総動員を発令しますか？\nこの操作は取り消せません。")) {
            sendPost('mobilize', 1);
        }
    }

    // データの送信（CORS回避のため text/plain で送るのがGAS定石の一つだが、fetchでno-corsだとレスポンス読めない。
    // 今回はCORSヘッダ付きのレスポンスをGAS側で返す構成にしている前提。）
    async function sendPost(type, value) {
        const payload = {
            country: country,
            type: type,
            value: value
        };

        try {
            // sendBeaconではなくfetchを使う
            const response = await fetch(GAS_API_URL, {
                method: 'POST',
                body: JSON.stringify(payload)
                // ヘッダーを指定するとOPTIONSプリフライトが飛びCORSエラーになりやすいので
                // GAS側で text/plain として受け取るよう実装済み (e.postData.contents)
            });
            
            const res = await response.json();
            if (res.success) {
                // 成功したらデータを再読み込みして画面更新
                loadData();
            } else {
                alert('エラー: ' + res.message);
            }
        } catch (e) {
            console.error(e);
            // GASの仕様上、リダイレクト周りでエラーに見えることがあるが処理されている場合も多い
            // ここでは簡易的にリロード
            setTimeout(loadData, 1000); 
        }
    }
    
    // モーダル外クリックで閉じる
    window.onclick = function(event) {
        if (event.target.classList.contains('modal')) {
            event.target.style.display = "none";
        }
    }
</script>

</body>
</html>
